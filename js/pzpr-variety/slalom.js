/*! @license pzpr.js v0.11.1 (c) 2009-2019 sabo2, MIT license
 *   https://github.com/sabo2/pzprv3 */

!function(a,b){"object"==typeof module&&module.exports?module.exports=[a,b]:pzpr.classmgr.makeCustom(a,b)}(["slalom"],{MouseEvent:{inputModes:{edit:["number","direc","clear","info-line"],play:["line","peke","info-line"]},mouseinput_auto:function(){this.puzzle.playmode?"left"===this.btn?this.mousestart||this.mousemove?this.inputLine():this.mouseend&&this.notInputted()&&this.inputpeke():"right"===this.btn&&(this.mousestart||this.mousemove)&&this.inputpeke():this.puzzle.editmode&&(this.mousestart||this.mousemove?this.inputEdit():this.mouseend&&this.inputEdit_end())},inputEdit:function(){var a=this.getcell();a.isnull||(this.mouseCell.isnull&&this.inputEdit_first(a),10===this.inputData?this.board.startpos.input(a):2===this.inputData?this.inputdirec():this.inputGate(a),this.mouseCell=a)},inputEdit_first:function(a){a===this.board.startpos.getc()?this.inputData=10:1===a.ques&&a.isNum()?this.inputData=2:this.firstPoint.set(this.inputPoint)},inputGate:function(a){var b=a.getaddr(),c=!1;if(1===a.ques);else if(null===this.inputData){if(a===this.mouseCell){var d=Math.abs(this.inputPoint.bx-this.firstPoint.bx),e=Math.abs(this.inputPoint.by-this.firstPoint.by);e>=.25?(this.inputData=21,c=!0):d>=.25&&(this.inputData=22,c=!0)}else{var f=this.prevPos.getvert(b,2);void 0!==f&&(this.inputData=f?21:22,c=!0)}c&&(a.ques===this.inputData&&(this.inputData=0),this.firstPoint.reset())}else if(a!==this.mouseCell)if(0===this.inputData)this.inputData=0,c=!0;else{var f=this.prevPos.getvert(b,2);void 0!==f&&(this.inputData=f?21:22,c=!0)}if(this.prevPos=b,c){var g=this.board;a.setQues(this.inputData),g.gatemgr.rebuild(),a.draw(),g.startpos.draw()}},inputEdit_end:function(){var a=this.getcell();a.isnull||(10===this.inputData?(this.inputData=null,a.draw()):this.notInputted()&&(a!==this.cursor.getc()?this.setcursor(a):this.inputGateNumber(a)))},inputGateNumber:function(a){var b=this.board;"left"===this.btn?a.setQues({0:1,1:21,21:22,22:0}[a.ques]):"right"===this.btn&&a.setQues({0:22,22:21,21:1,1:0}[a.ques]),a.setNum(-1),b.gatemgr.rebuild(),a.draw(),b.startpos.draw()}},KeyEvent:{enablemake:!0,moveTarget:function(a){return!a.match(/shift/)&&this.moveTCell(a)},keyDispInfo:function(a){return"x"!==a||(this.puzzle.painter.drawNumbersOnGate(!!this.keydown),!1)},keyinput:function(a){this.key_inputdirec(a)||this.key_inputqnum_slalom(a)},key_inputqnum_slalom:function(a){var b=this.cursor.getc(),c=this.board;if("q"===a||"w"===a||"e"===a||"r"===a||"s"===a||" "===a){var d=b.ques,e=-1;if("q"===a)e=1!==d?1:0;else if("w"===a)e=21;else if("e"===a)e=22;else if("r"===a||" "===a)e=0;else{if("s"!==a)return;c.startpos.input(b)}if(d===e)return;-1!==e&&(b.setQues(e),0===e&&b.setNum(-1),21!==d&&22!==d&&21!==e&&22!==e||c.gatemgr.rebuild(),b.draw(),c.startpos.draw())}else 1===b.ques&&this.key_inputqnum(a)}},Cell:{disInputHatena:!0,maxnum:function(){return Math.min(999,this.board.gatemgr.components.length)},posthook:{qnum:function(a){this.board.gatemgr.generateGateNumberAll()},qdir:function(a){this.board.gatemgr.generateGateNumberAll()}},gate:null,getConnectingGate:function(){var a,b=this.adjacent,c=[];return a=b.top,a.isnull||21!==a.ques||c.push(a.gate),a=b.bottom,a.isnull||21!==a.ques||c.push(a.gate),a=b.left,a.isnull||22!==a.ques||c.push(a.gate),a=b.right,a.isnull||22!==a.ques||c.push(a.gate),c}},Border:{enableLineNG:!0},Board:{hasborder:1,startpos:null,gatemgr:null,gates:null,addExtraInfo:function(){this.gatemgr=this.addInfoList(this.klass.AreaHurdleGraph)},createExtraObject:function(){this.startpos=new this.klass.StartPosAddress(1,1)},initExtraObject:function(a,b){this.startpos.set(this.cell[0])},operate:function(a){switch(a){case"showgatenumber":this.puzzle.painter.drawNumbersOnGate(!0);break;case"hidegatenumber":this.puzzle.painter.drawNumbersOnGate(!1);break;default:this.common.operate.call(this,a)}}},BoardExec:{posinfo:{},adjustBoardData:function(a,b){var c=this.board;if(a&this.TURN)for(var d={21:22,22:21},e=c.cellinside(b.x1,b.y1,b.x2,b.y2),f=0;f<e.length;f++){var g=e[f],h=d[g.ques];h&&g.setQues(h)}this.posinfo=this.getAfterPos(a,b,c.startpos.getc()),this.adjustNumberArrow(a,b)},adjustBoardData2:function(a,b){var c,d=this.board,e=this.puzzle.opemgr,f=this.posinfo;c=a&this.REDUCE&&f.isdel&&!e.undoExec&&!e.redoExec,c&&(e.forceRecord=!0),d.startpos.set(f.pos.getc()),c&&(e.forceRecord=!1),d.gatemgr.rebuild()}},"StartPosAddress:Address":{input:function(a){var b=this.clone();this.equals(a)||(this.set(a),b.draw()),this.draw()},set:function(a){this.addOpe(a.bx,a.by),this.bx=a.bx,this.by=a.by},addOpe:function(a,b){!this.puzzle.ready||this.bx===a&&this.by===b||this.puzzle.opemgr.add(new this.klass.StartposOperation(this.bx,this.by,a,b))}},"StartposOperation:Operation":{setData:function(a,b,c,d){this.bx1=a,this.by1=b,this.bx2=c,this.by2=d},decode:function(a){return"PS"===a[0]&&(this.bx1=+a[1],this.by1=+a[2],this.bx2=+a[3],this.by2=+a[4],!0)},toString:function(){return["PS",this.bx1,this.by1,this.bx2,this.by2].join(",")},isModify:function(a){return!(!this.manager.changeflag||a.bx2!==this.bx1||a.by2!==this.by1)&&(a.bx2=this.bx2,a.by2=this.by2,!0)},undo:function(){this.exec(this.bx1,this.by1)},redo:function(){this.exec(this.bx2,this.by2)},exec:function(a,b){var c=this.board,d=c.getc(a,b);c.startpos.input(d)}},OperationManager:{addExtraOperation:function(){this.operationlist.push(this.klass.StartposOperation)}},LineGraph:{enabled:!0},"AreaHurdleGraph:AreaGraphBase":{enabled:!0,relation:{"cell.ques":"node"},setComponentRefs:function(a,b){a.gate=b},getObjNodeList:function(a){return a.gatenodes},resetObjNodeList:function(a){a.gatenodes=[]},isnodevalid:function(a){return 21===a.ques||22===a.ques},isedgevalidbynodeobj:function(a,b){var c=a.getdir(b,2);return c===a.UP||c===a.DN?21===a.ques&&21===b.ques:(c===a.LT||c===a.RT)&&(22===a.ques&&22===b.ques)},rebuild:function(){this.klass.AreaGraphBase.prototype.rebuild.call(this),this.generateGateNumberAll()},remakeComponent:function(){this.klass.AreaGraphBase.prototype.remakeComponent.call(this),this.generateGateNumberAll()},resetExtraData:function(a){a.gate=null},setExtraData:function(a){a.clist=new this.klass.CellList(a.getnodeobjs()),a.vert=21===a.clist[0].ques,a.number=-1},generateGateNumberAll:function(){for(var a=this.board,b=this.components,c=0;c<b.length;c++)b[c].number=-1;for(var d={nums:[],done:[],erase:function(){for(var a=this.done,c=0;c<b.length;c++)this.nums[c]=this.nums[c].filter(function(b){return!a[b]})}},c=0;c<b.length;c++)d.nums[c]=[];for(var e=0;e<b.length;e++)d.done[e]=!1;for(var f=0;f<a.cell.length;f++){var g=a.cell[f];if(1===g.ques){var h=g.qnum,i=g.qdir,j=g.adjacent;if(h<=0)continue;i!==g.NDIR&&i!==g.UP||21!==j.top.ques||d.nums[b.indexOf(j.top.gate)].push(h),i!==g.NDIR&&i!==g.DN||21!==j.bottom.ques||d.nums[b.indexOf(j.bottom.gate)].push(h),i!==g.NDIR&&i!==g.LT||22!==j.left.ques||d.nums[b.indexOf(j.left.gate)].push(h),i!==g.NDIR&&i!==g.RT||22!==j.right.ques||d.nums[b.indexOf(j.right.gate)].push(h)}}for(var c=0;c<b.length;c++){var k=d.nums[c];2===k.length&&k[0]>0&&k[0]===k[1]&&(b[c].number=k[0],d.done[k[0]]=!0,d.nums[c]=[])}d.erase();for(var l=!0;l;){l=!1;for(var m=[],e=0;e<b.length;e++)m[e]=0;for(var c=0;c<b.length;c++){var k=d.nums[c];1===k.length&&m[k[0]]++}for(var c=0;c<b.length;c++){var n=b[c],k=d.nums[c],o=1===k.length?k[0]:-1;o>0&&m[o]>1&&(o=-1),o>0&&(n.number=o,d.done[o]=!0,d.nums[c]=[],l=!0)}if(d.erase(),!l){for(var e=0;e<b.length;e++)m[e]=0;for(var c=0;c<b.length;c++)d.nums[c].forEach(function(a){m[a]++});for(var c=0;c<b.length;c++){for(var n=b[c],k=d.nums[c],o=-1,p=0;p<k.length;p++)1===m[k[p]]&&(o=-1===o?k[p]:-1);o>0&&(n.number=o,d.done[o]=!0,d.nums[c]=[],l=!0)}d.erase()}}},setGateError:function(a,b){var c,d,e=this.board,f=new this.klass.CellList,g=a.clist.getRectSize();a.vert?(c=e.getc(g.x1,g.y1-2),d=e.getc(g.x1,g.y2+2)):(c=e.getc(g.x1-2,g.y1),d=e.getc(g.x2+2,g.y1)),c.isnull||1!==c.ques||f.add(c),d.isnull||1!==d.ques||f.add(d),f.seterr(b)}},Graphic:{irowake:!0,gridcolor_type:"LIGHT",fontShadecolor:"white",numbercolor_func:"fixed_shaded",linecolor:"rgb(32, 32, 255)",noerrcolor:"rgb(160, 150, 255)",paint:function(){this.drawBGCells(),this.drawGrid(),this.drawGates(),this.drawQuesCells(),this.drawArrowNumbers(),this.drawPekes(),this.drawLines(),this.drawStartpos(),this.drawChassis(),this.drawTarget()},drawGates:function(){for(var a=this.vinc("cell_gate","auto",!0),b=Math.max(this.cw/10,3),c=b/2,d=1.1*b,e=this.range.cells,f=0;f<e.length;f++){var g=e[f];if(a.fillStyle=4===g.error?this.errcolor1:this.quescolor,a.vid="c_dl21_"+g.id,21===g.ques){var h,i=g.bx*this.bw-c+1,j=(g.by-1)*this.bh,k=j+this.ch;for(a.beginPath(),h=j;h<k;h+=2*d)a.rect(i,h,b,d);a.fill()}else a.vhide();if(a.vid="c_dl22_"+g.id,22===g.ques){var i,h=g.by*this.bh-c+1,l=(g.bx-1)*this.bw,k=l+this.cw;for(a.beginPath(),i=l;i<k;i+=2*d)a.rect(i,h,d,b);a.fill()}else a.vhide()}},drawStartpos:function(){var a=this.vinc("cell_circle","auto"),b=this.board,c=b.startpos.getc(),d=this.range;if(!(c.bx<d.x1||d.x2<c.bx||c.by<d.y1||d.y2<c.by)){var e=c.bx*this.bw,f=c.by*this.bh,g=.42*this.cw;a.vid="c_stpos",a.lineWidth=Math.max(.05*this.cw,1),a.strokeStyle=this.quescolor,a.fillStyle=10===this.puzzle.mouse.inputData?this.errbcolor1:"white",a.shapeCircle(e,f,g),a.vid="text_stpos",a.fillStyle=this.quescolor,this.disptext(""+b.gatemgr.components.length,e,f,{ratio:.75})}},repaintParts:function(a){for(var b=a.cellinside(),c=0;c<b.length;c++){var d=b[c];if(this.board.startpos.equals(d)){this.range={x1:d.bx,y1:d.by,x2:d.bx,y2:d.by},this.drawStartpos();break}}},drawNumbersOnGate:function(a){var b=this.context,c=this.board;a&&c.gatemgr.generateGateNumberAll();for(var d=0;d<c.cell.length;d++){var e=c.cell[d];if(21===e.ques||22===e.ques){var f=e.gate.number;b.vid="cell_text_"+d,a&&f>0?(b.fillStyle="tomato",this.disptext(""+f,e.bx*this.bw,e.by*this.bh)):b.vhide()}}}},Encode:{decodePzpr:function(a){var b=this.checkpflag("d")?2:this.checkpflag("p")?1:0;this.decodeSlalom(b)},encodePzpr:function(a){var b=this.puzzle.pzpr.parser;return a===b.URL_PZPRV3&&(this.outpflag="d"),this.encodeSlalom(a===b.URL_PZPRV3?2:0)},decodeKanpen:function(){this.fio.decodeBoard_kanpen()},encodeKanpen:function(){this.fio.encodeBoard_kanpen()},decodeSlalom:function(a){var b=this.outbstr,c=b.split("/"),d=0,e=0,f=this.board;for(e=0;e<c[0].length;e++){var g=c[0].charAt(e),h=f.cell[d];if("1"===g?h.ques=1:"2"===g?h.ques=21:"3"===g?h.ques=22:(this.include(g,"4","9")||this.include(g,"a","z"))&&(d+=parseInt(g,36)-4),d++,!f.cell[d])break}if(f.gatemgr.rebuild(),0===a){var i=0;for(e+=1;e<c[0].length;e++){var g=c[0].charAt(e);if(this.include(g,"0","9")||this.include(g,"a","f")?f.gatemgr.components[i].number=parseInt(g,16):"-"===g?(f.gatemgr.components[i].number=parseInt(b.substr(e+1,2),16),e+=2):this.include(g,"g","z")&&(i+=parseInt(g,36)-16),++i>f.gatemgr.components.length)break}for(var d=0;d<f.cell.length;d++){for(var j=f.cell[d].getConnectingGate(),k=1e3,e=0;e<j.length;e++){var l=j[e].number;l>0&&(k=Math.min(k,l))}f.cell[d].qnum=k<1e3?k:-1}}else if(1===a||2===a){var d=0,m=0;for(e+=1;e<c[0].length;e++){var h=f.cell[d];if(1!==h.ques)e--;else if(m>0)e--,m--;else{var g=c[0].charAt(e);1===a&&(this.include(g,"0","9")||this.include(g,"a","f"))?h.qnum=parseInt(g,16):1===a&&"-"===g?(h.qnum=parseInt(b.substr(e+1,2),16),e+=2):2===a&&this.include(g,"0","4")?(h.qdir=parseInt(g,16),h.qnum=parseInt(b.charAt(e+1),16),e++):2===a&&this.include(g,"5","9")?(h.qdir=parseInt(g,16)-5,h.qnum=parseInt(b.substr(e+1,2),16),e+=2):2===a&&"-"===g?(h.qdir=parseInt(b.substr(e+1,1),16),h.qnum=parseInt(b.substr(e+2,3),16),e+=4):g>="g"&&g<="z"&&(m=parseInt(g,36)-15-1)}if(d++,!f.cell[d])break}}f.startpos.set(f.cell[+c[1]||0]),this.outbstr=c[0].substr(e)},encodeSlalom:function(a){for(var b="",c=0,d=this.board,e=0;e<d.cell.length;e++){var f="",g=d.cell[e];1===g.ques?f="1":21===g.ques?f="2":22===g.ques?f="3":c++,0===c?b+=f:(f||32===c)&&(b+=(3+c).toString(36)+f,c=0)}if(c>0&&(b+=(3+c).toString(36)),c=0,0===a){for(var h=0;h<d.gatemgr.components.length;h++){var f="",i=d.gatemgr.components[h].number;i>=0&&i<16?f=i.toString(16):i>=16&&i<256?f="-"+i.toString(16):c++,0===c?b+=f:(f||20===c)&&(b+=(15+c).toString(36)+f,c=0)}c>0&&(b+=(15+c).toString(36))}else if(1===a||2===a){for(var e=0;e<d.cell.length;e++){var g=d.cell[e];if(1===g.ques){var f="",i=g.qnum,j=g.qdir;i>=1&&i<16?f=(1===a?"":""+j)+i.toString(16):i>=16&&i<256?f=(1===a?"-":""+(j+5))+i.toString(16):i>=256&&i<4096?f="-"+j+i.toString(16):c++,0===c?b+=f:(f||20===c)&&(b+=(15+c).toString(36)+f,c=0)}}c>0&&(b+=(15+c).toString(36))}b+="/"+d.startpos.getc().id,this.outbstr+=b}},FileIO:{decodeData:function(){2===this.filever?this.decodeBoard_pzpr2():1===this.filever?this.decodeBoard_pzpr1():0===this.filever&&this.decodeBoard_old(),this.decodeBorderLine()},encodeData:function(){this.filever=2,this.encodeBoard_pzpr2(),this.encodeBorderLine()},kanpenOpen:function(){this.decodeBoard_kanpen(),this.decodeBorderLine()},kanpenSave:function(){this.encodeBoard_kanpen(),this.encodeBorderLine()},decodeBoard_pzpr1:function(){var a=this.board;this.decodeCell(function(b,c){"o"===c?a.startpos.set(b):"i"===c?b.ques=21:"-"===c?b.ques=22:"#"===c?b.ques=1:"."!==c&&(b.ques=1,b.qnum=+c)}),a.gatemgr.rebuild()},decodeBoard_pzpr2:function(){var a=this.board;this.decodeCell(function(b,c){if("o"===c)a.startpos.set(b);else if("i"===c)b.ques=21;else if("-"===c)b.ques=22;else if("#"===c)b.ques=1;else if("."!==c){var d=c.split(",");b.ques=1,b.qdir="0"!==d[0]?+d[0]:0,b.qnum="-"!==d[1]?+d[1]:-2}}),a.gatemgr.rebuild()},encodeBoard_pzpr2:function(){var a=this.board;this.encodeCell(function(b){if(a.startpos.equals(b))return"o ";if(21===b.ques)return"i ";if(22===b.ques)return"- ";if(1===b.ques&&b.qnum<=0)return"# ";if(1===b.ques){return[0!==b.qdir?""+b.qdir:"0",",",-2!==b.qnum?""+b.qnum:"-"," "].join("")}return". "})},decodeBoard_kanpen:function(){var a=this.board;this.decodeCell(function(b,c){"+"===c?a.startpos.set(b):"|"===c?b.ques=21:"-"===c?b.ques=22:"0"===c?b.ques=1:"."!==c&&(b.ques=1,b.qnum=+c)}),a.gatemgr.rebuild()},encodeBoard_kanpen:function(){var a=this.board;this.encodeCell(function(b){return a.startpos.equals(b)?"+ ":21===b.ques?"| ":22===b.ques?"- ":1===b.ques?b.qnum>0?b.qnum+" ":"0 ":". "})},kanpenOpenXML:function(){this.decodeCellSlalom_XMLBoard(),this.decodeBorderLine_XMLAnswer()},kanpenSaveXML:function(){this.encodeCellSlalom_XMLBoard(),this.encodeBorderLine_XMLAnswer()},UNDECIDED_NUM_XML:-3,decodeCellSlalom_XMLBoard:function(){var a=this.board;this.decodeCellXMLBoard(function(b,c){c>=0?(b.ques=1,c>0&&(b.qnum=c)):-5===c?b.ques=21:-4===c?b.ques=22:-1===c&&a.startpos.set(b)}),a.gatemgr.rebuild()},encodeCellSlalom_XMLBoard:function(){var a=this.board;this.encodeCellXMLBoard(function(b){var c=-3;return 1===b.ques?c=b.qnum>0?b.qnum:0:21===b.ques?c=-5:22===b.ques?c=-4:a.startpos.equals(b)&&(c=-1),c})},decodeBoard_old:function(){var a=[],b=this.board;this.decodeCell(function(c,d){var e=c.id;a[e]=-1,"#"===d?c.ques=1:"o"===d?b.startpos.set(c):"."!==d&&("i"===d.charAt(0)?c.ques=21:"w"===d.charAt(0)&&(c.ques=22),d.length>1&&(a[e]=+d.substr(1)))}),b.gatemgr.rebuild();for(var c=0;c<b.cell.length;c++)-1!==a[c]&&(b.cell[c].gate.number=a[c]);for(var c=0;c<b.cell.length;c++){for(var d=b.cell[c].getConnectingGate(),e=1e3,f=0;f<d.length;f++){var g=d[f].number;g>0&&(e=Math.min(e,g))}b.cell[c].qnum=e<1e3?e:-1}}},AnsCheck:{checklist:["checkLineOnShadeCell","checkCrossLine","checkBranchLine","checkPassGateOnce","checkStartid","checkGateNumber","checkDeadendLine+","checkOneLoop","checkPassAllGate"],checkStartid:function(){var a=this.board.startpos.getc();2!==a.lcnt&&(a.seterr(1),this.failcode.add("stLineNe2"))},checkPassGateOnce:function(){return this.checkGateLine(1,"gateRedup")},checkPassAllGate:function(){return this.checkGateLine(2,"gateUnpass")},checkGateLine:function(a,b){for(var c=this.board,d=c.gatemgr.components,e=0;e<d.length;e++){for(var f=0,g=d[e].clist,h=0;h<g.length;h++)g[h].lcnt>0&&f++;if(!(1===a&&f<=1||2===a&&f>0)){if(this.failcode.add(b),this.checkOnly)break;g.seterr(4),c.gatemgr.setGateError(d[e],1)}}},checkGateNumber:function(){var a=this.getTraceInfo();null!==a&&(this.failcode.add("lrOrder"),a.clist.seterr(4),this.board.gatemgr.setGateError(a,1))},getTraceInfo:function(){return this.searchTraceInfo(this.board.startpos.getc())},searchTraceInfo:function(a){if(0===a.lcnt)return null;for(var b=null,c=a.getdir(a.pathnodes[0].nodes[0].obj,2),d=a.getaddr(),e=0,f=-1,g=this.board.gatemgr.components.length;;)if(d.movedir(c,1),d.oncell()){var h=d.getc();if(a===h)break;if(21===h.ques||22===h.ques){var i=h.gate;e++;var j=i.number;if(j<=0);else if(-1===f){var k=g+1-j;if(j===k);else{if(e!==j){if(e===k){if(a.lcnt<2)break;c=a.getdir(a.pathnodes[0].nodes[1].obj,2),d=a.getaddr(),e=0,f=1;continue}b=i;break}f=1}}else if(1===f&&e!==j){b=i;break}}var l=h.adjborder;if(2!==h.lcnt)break;1!==c&&l.bottom.isLine()?c=2:2!==c&&l.top.isLine()?c=1:3!==c&&l.right.isLine()?c=4:4!==c&&l.left.isLine()&&(c=3)}else if(!d.getb().isLine())break;return b}},FailCode:{gateRedup:["線が２回以上通過している旗門があります。","A line goes through a gate twice or more."],gateUnpass:["線が通過していない旗門があります。","There is a gate that the line is not passing."],lrOrder:["旗門を通過する順番が間違っています。","The order of passing the gate is wrong."],stLineNe2:["○から線が２本出ていません。","Start/goal circle doesn't have two lines."]}});