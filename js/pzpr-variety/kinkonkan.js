/*! @license pzpr.js v0.11.1 (c) 2009-2019 sabo2, MIT license
 *   https://github.com/sabo2/pzprv3 */

!function(a,b){"object"==typeof module&&module.exports?module.exports=[a,b]:pzpr.classmgr.makeCustom(a,b)}(["kinkonkan"],{MouseEvent:{inputModes:{edit:["border","letter","letter-","number","clear"]},mouseinput_clear:function(){this.inputclean_excell()},mouseinput_number:function(){this.mousestart&&this.inputqnum_excell()},mouseinput_other:function(){0===this.inputMode.indexOf("letter")&&this.mousestart&&this.inputqchar_excell()},mouseinput_auto:function(){this.puzzle.playmode?(this.mousestart||this.mousemove&&null!==this.inputData)&&this.inputslash():this.puzzle.editmode&&(this.mousestart?this.inputedit_onstart():this.mousemove&&"left"===this.btn&&this.inputborder())},mouseevent:function(a){if(this.isclearflash=!1,0===a){var b=this.getpos(0).getex();b.isnull||1!==b.qinfo||(this.isclearflash=!0)}this.common.mouseevent.call(this,a)},inputslash:function(){var a=this.getcell();if(a.isnull)return void this.inputflash();var b=this.inputData;if(-1===b||0===b);else{if(null!==b)return;var c=a.getState();"left"===this.btn?b=(c+6)%4-1:"right"===this.btn&&(b=(c+4)%4-1)}a.setState(b),a.drawaround(),this.inputData=b},inputflash:function(){var a=this.getpos(0).getex(),b=this.puzzle,c=b.board;a.isnull||this.mouseCell===a||(this.isclearflash?(c.lightclear(),this.mousereset()):(c.flashlight(a),this.inputData=11,this.mouseCell=a))},inputedit_onstart:function(){var a=this.getcell_excell(),b=this.board;if(!a.isnull)if("excell"!==a.group)this.inputborder();else if(a!==this.cursor.getex())this.setcursor(a),this.mousereset();else{var c=a;1!==c.qinfo?b.flashlight(c):b.lightclear(),this.mousereset()}},inputclean_excell:function(){var a=this.getcell_excell();if(!a.isnull&&"excell"===a.group){this.mouseCell=a;var b=new this.klass.EXCellList([a]);this.puzzle.playmode?b.ansclear():b.allclear(),a.draw()}},inputqnum_excell:function(){var a=this.getcell_excell();a.isnull||"excell"!==a.group||(a!==this.cursor.getex()?this.setcursor(a):this.inputqnum_main(a))},inputqchar_excell:function(){var a=this.getcell_excell();if(!a.isnull&&"excell"===a.group)if(a!==this.cursor.getex())this.setcursor(a);else{var b=a.qchar,c="letter"===this.inputMode==("left"===this.btn);b=c?b<104?b+1:0:b>0?b-1:104,a.setQchar(b),a.draw()}}},KeyEvent:{enablemake:!0,moveTarget:function(a){return this.moveEXCell(a)},keyinput:function(a){this.key_inputexcell(a)},key_inputexcell:function(a){var b=this.cursor.getex(),c=this.board;if(b.bx!==c.minbx+1&&b.bx!==c.maxbx-1||b.by!==c.minby+1&&b.by!==c.maxby-1){var d=b.qnum;if("0"<=a&&a<="9"){var e=+a,f=b.getmaxnum();d<=0||this.prev!==b?e<=f&&b.setQnum(e):10*d+e<=f?b.setQnum(10*d+e):e<=f&&b.setQnum(e)}else if(1===a.length&&"a"<=a&&a<="z"){var e=parseInt(a,36)-10,g=b.qchar;(g-1)%26===e&&g>0&&g<79?b.setQchar(g+26):(g-1)%26===e?b.setQchar(0):b.setQchar(e+1)}else if("-"===a)-1!==d?b.setQnum(-1):(b.setQnum(-1),b.setQchar(0));else if("F4"===a)1!==b.qinfo?c.flashlight(b):c.lightclear();else{if(" "!==a)return;b.setQnum(-1),b.setQchar(0)}this.prev=b,this.cursor.draw()}}},TargetCursor:{initCursor:function(){this.init(-1,-1)}},Cell:{getState:function(){return this.qans>30?this.qans-30:0!==this.qsub?-1:0},setState:function(a){var b=[-1,0,31,32][a+1];-1!==b?(this.setQans(b),this.setQsub(0)):(this.setQans(0),this.setQsub(1))}},EXCell:{disInputHatena:!0,minnum:0},Board:{cols:8,rows:8,hasborder:1,hasexcell:2,haslight:!1,flashlight:function(a){this.lightclear(),this.searchLight(a,!0),this.puzzle.redraw()},lightclear:function(){if(this.haslight){for(var a=0;a<this.cell.length;a++)this.cell[a].qinfo=0;for(var a=0;a<this.excell.length;a++)this.excell[a].qinfo=0;this.haslight=!1,this.puzzle.redraw()}},searchLight:function(a,b){for(var c=0,d=[],e=0;e<this.cell.length;e++)d[e]=0;var f=a.getaddr(),g=0;for(f.by===this.minby+1?g=2:f.by===this.maxby-1?g=1:f.bx===this.minbx+1?g=4:f.bx===this.maxbx-1&&(g=3);0!==g;){f.movedir(g,2);var h=f.getc();if(h.isnull)break;var i=h.qans,j=h.id;if(31===i)1===g?(d[j]=isNaN({4:1,1:1}[d[j]])?2:1,g=3):2===g?(d[j]=isNaN({2:1,1:1}[d[j]])?4:1,g=4):3===g?(d[j]=isNaN({2:1,1:1}[d[j]])?4:1,g=1):4===g&&(d[j]=isNaN({4:1,1:1}[d[j]])?2:1,g=2);else{if(32!==i){d[j]=1;continue}1===g?(d[j]=isNaN({5:1,1:1}[d[j]])?3:1,g=4):2===g?(d[j]=isNaN({3:1,1:1}[d[j]])?5:1,g=3):3===g?(d[j]=isNaN({5:1,1:1}[d[j]])?3:1,g=2):4===g&&(d[j]=isNaN({3:1,1:1}[d[j]])?5:1,g=1)}if(++c>this.cell.length)break}var k=f.getex().id;if(b){for(var e=0;e<this.excell.length;e++)this.excell[e].qinfo=0;a.qinfo=1,this.excell[k].qinfo=1;for(var e=0;e<this.cell.length;e++)this.cell[e].qinfo=d[e];this.hasinfo=!0}return{cnt:c,dest:k}}},BoardExec:{adjustBoardData:function(a,b){if(a&this.TURNFLIP)for(var c=this.board.cell,d=0;d<c.length;d++){var e=c[d];e.setQans({0:0,31:32,32:31}[e.qans])}}},AreaRoomGraph:{enabled:!0},Graphic:{gridcolor_type:"LIGHT",errcolor1:"black",errcolor2:"black",lightcolor:"rgb(255, 255, 127)",paint:function(){this.drawBGCells_kinkonkan(),this.drawDotCells(),this.drawGrid(),this.drawBorders(),this.drawSlashes(),this.drawBGEXcells(),this.drawNumbersEXcell(),this.drawChassis(),this.drawTarget()},drawBGCells_kinkonkan:function(){for(var a=this.vinc("cell_back","crispEdges"),b=this.range.cells,c=0;c<b.length;c++){var d=b[c],e=d.error||d.qinfo,f=d.bx*this.bw,g=d.by*this.bh;a.fillStyle=0!==d.error?this.errbcolor1:this.lightcolor,a.vid="c_bglight_"+d.id,1===e?a.fillRectCenter(f,g,this.bw+.5,this.bh+.5):0!==e?this.drawTriangle1(f,g,d.qinfo):a.vhide()}},getBGEXcellColor:function(a){return 1===a.qinfo?this.lightcolor:null},fontsizeratio:.6,fontwidth:[null,.5,.4],getQuesNumberText:function(a){var b="",c=a.qchar,d=a.qnum;return b=0===c?"":this.getNumberTextCore_letter(c<=52?c:c-52),d>=0&&(b+=d.toString(10)),b},getQuesNumberColor:function(a){return 1===a.error?"rgb(192, 0, 0)":a.qchar>52?"blue":this.quescolor}},Encode:{decodePzpr:function(a){this.decodeBorder(),this.decodeKinkonkan()},encodePzpr:function(a){this.encodeBorder(),this.encodeKinkonkan()},decodeKinkonkan:function(){for(var a=[],b=0,c=0,d=this.outbstr,e=this.board,f=0;f<d.length;f++){var g=d.charAt(f),h=e.excell[b];if(this.include(g,"A","Z")?(a.push(b),h.qchar=parseInt(g,36)-9):this.include(g,"0","9")?(a.push(b),h.qchar=parseInt(g,36)-9+26*(parseInt(d.charAt(f+1),10)+1),f++):this.include(g,"a","z")&&(b+=parseInt(g,36)-10),++b>=e.excell.length){c=f+1;break}}b=0;for(var f=c;f<d.length;f++){var g=d.charAt(f),h=e.excell[a[b]];if("."===g?h.qnum=-2:"-"===g?(h.qnum=parseInt(d.substr(f+1,2),16),f+=2):h.qnum=parseInt(d.substr(f,1),16),++b>=a.length){c=f+1;break}}this.outbstr=d.substr(c)},encodeKinkonkan:function(){for(var a="",b="",c=this.board,d=0,e=0;e<c.excell.length;e++){var f="",g=c.excell[e].qchar,h=c.excell[e].qnum;g>0&&g<=104?(f=g<=26?(g+9).toString(36).toUpperCase():((g-1)/26-1|0).toString(10)+((g-1)%26+10).toString(16).toUpperCase(),b+=-2===h?".":h<16?""+h.toString(16):"-"+h.toString(16)):d++,0===d?a+=f:(f||26===d)&&(a+=(9+d).toString(36)+f,d=0)}d>0&&(a+=(9+d).toString(36)),this.outbstr+=a+b}},FileIO:{decodeData:function(){this.decodeAreaRoom(),this.decodeKinkonkan(),0===this.filever&&this.decodeKinkonkanAns_old()},encodeData:function(){this.filever=1,this.encodeAreaRoom(),this.encodeKinkonkan()},decodeKinkonkan:function(){var a=this.filever;this.decodeCellExcell(function(b,c){if("."!==c)if("excell"===b.group){var d=c.split(",");""!==d[0]&&(b.qchar=+d[0]),""!==d[1]&&(b.qnum=+d[1])}else"cell"===b.group&&1===a&&("+"===c?b.qsub=1:"1"===c?b.qans=31:"2"===c&&(b.qans=32))})},encodeKinkonkan:function(){this.encodeCellExcell(function(a){if(a.isnull);else if("excell"===a.group){var b=a.qchar,c=a.qnum,d=0!==b?""+b:"",e=-1!==c?""+c:"";if(d||e)return d+","+e+" "}else if("cell"===a.group){if(31===a.qans)return"1 ";if(32===a.qans)return"2 ";if(1===a.qsub)return"+ "}return". "})},decodeKinkonkanAns_old:function(){this.decodeCell(function(a,b){"+"===b?a.qsub=1:"1"===b?a.qans=31:"2"===b&&(a.qans=32)})}},AnsCheck:{checklist:["checkSingleMirrorInRoom","checkPairMirror","checkReflectionCount","checkExistMirrorInRoom"],checkSingleMirrorInRoom:function(){this.checkAllBlock(this.board.roommgr,function(a){return 0!==a.qans},function(a,b,c,d){return c<=1},"bkObjGe2")},checkExistMirrorInRoom:function(){this.checkAllBlock(this.board.roommgr,function(a){return 0!==a.qans},function(a,b,c,d){return 0!==c},"bkNoObj")},checkPairMirror:function(){this.checkMirrors(1,"pairedLetterNe")},checkReflectionCount:function(){this.checkMirrors(2,"pairedNumberNe")},checkMirrors:function(a,b){for(var c=[],d=this.board,e=!0,f=null,g=0;g<d.excell.length;g++){var h=d.excell[g];if(isNaN(c[g])&&-1!==h.qnum&&0!==h.qchar){var i=d.searchLight(h,!1),j=d.excell[i.dest];if(1===a&&h.qchar!==j.qchar||2===a&&(h.qnum!==j.qnum||h.qnum!==i.cnt)){if(e=!1,this.checkOnly)break;h.seterr(1),j.seterr(1),f||(f=h)}c[g]=1,c[i.dest]=1}}e||(this.failcode.add(b),f&&d.searchLight(f,!0))}},FailCode:{bkNoObj:["斜線の引かれていない部屋があります。","A room has no mirrors."],bkObjGe2:["斜線が複数引かれた部屋があります。","A room has plural mirrors."],pairedLetterNe:["光が同じ文字の場所へ到達しません。","Beam from a light doesn't reach one's pair."],pairedNumberNe:["光の反射回数が正しくありません。","The count of refrection is wrong."]}});